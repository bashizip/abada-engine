services:
  # PostgreSQL for production
  postgres:
    image: postgres:15-alpine
    container_name: postgres-prod
    environment:
      - POSTGRES_DB=abada_engine
      - POSTGRES_USER=abada
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres_secure_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - abada-internal
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U abada -d abada_engine"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Abada Engine for production (multiple replicas)
  abada-engine:
    build:
      context: ./engine
      dockerfile: Dockerfile.prod.engine
    image: abada-engine:latest
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SERVER_PORT=5601
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/abada_engine
      - SPRING_DATASOURCE_USERNAME=abada
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-postgres_secure_password}
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=0.1
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://otel-collector:4318/v1/traces
      - MANAGEMENT_OTLP_METRICS_ENDPOINT=http://otel-collector:4318/v1/metrics
      - OTEL_RESOURCE_ATTRIBUTES_DEPLOYMENT_ENVIRONMENT=prod
      - OTEL_SERVICE_NAME=abada-engine-prod
      - OTEL_RESOURCE_ATTRIBUTES=project=abada,service.version=0.8.3-alpha
    deploy:
      replicas: ${ABADA_ENGINE_REPLICAS:-3}
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    networks:
      - abada-internal
    restart: always
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5601/api/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      otel-collector:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.abada.rule=PathPrefix(`/api`)"
      - "traefik.http.services.abada.loadbalancer.server.port=5601"
      - "traefik.http.services.abada.loadbalancer.healthcheck.path=/api/actuator/health"
      - "traefik.http.services.abada.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.routers.abada.middlewares=oauth2-proxy-prod"
      - "traefik.http.middlewares.oauth2-proxy-prod.forwardauth.address=http://oauth2-proxy-prod:4180/oauth2/auth"
      - "traefik.http.middlewares.oauth2-proxy-prod.forwardauth.authResponseHeaders=X-Auth-Request-User,X-Auth-Request-Groups,X-Auth-Request-Email"

  # Keycloak Database for production
  keycloak-db:
    image: postgres:15-alpine
    container_name: keycloak-db-prod
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD} # Required, no default in prod
    volumes:
      - keycloak_data:/var/lib/postgresql/data
    networks:
      - abada-internal
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Keycloak for production
  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    container_name: keycloak-prod
    command: ["start", "--auto-build"]
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN_USERNAME} # Required from env
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD} # Required from env
      - KC_DB=postgres
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD}
      - KC_HOSTNAME=${KEYCLOAK_HOSTNAME} # e.g., auth.abada.dev
      - KC_PROXY=edge
      - KC_HTTP_ENABLED=true
      - KC_PROXY_HEADERS=xforwarded
    networks:
      - abada-internal
    restart: always
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 10
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`${KEYCLOAK_HOSTNAME}`)"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

  # OAuth2 Proxy for production
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.5.1
    container_name: oauth2-proxy-prod
    command:
      - "--provider=keycloak-oidc"
      - "--client-id=${OAUTH2_PROXY_CLIENT_ID}"
      - "--client-secret=${OAUTH2_PROXY_CLIENT_SECRET}"
      - "--cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET}"
      - "--oidc-issuer-url=https://${KEYCLOAK_HOSTNAME}/realms/abada-prod"
      - "--redirect-url=https://${APP_HOSTNAME}/oauth2/callback"
      - "--upstream=http://abada-engine:5601"
      - "--http-address=0.0.0.0:4180"
      - "--email-domain=*"
      - "--cookie-secure=true"
      - "--cookie-domain=${APP_HOSTNAME}"
      - "--set-xauthrequest=true"
      - "--pass-authorization-header=true"
      - "--pass-access-token=true"
      - "--skip-jwt-bearer-tokens=true"
    environment:
      - OAUTH2_PROXY_COOKIE_DOMAINS=${APP_HOSTNAME}
    networks:
      - abada-internal
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:4180/ping",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Abada Tenda - Frontend for production
  abada-tenda:
    build:
      context: ./tenda
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-bashizip}/abada-tenda:${VERSION:-latest}
    container_name: abada-tenda-prod
    environment:
      - NODE_ENV=production
    networks:
      - abada-internal
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tenda.rule=Host(`tenda.${APP_HOSTNAME}`)"
      - "traefik.http.routers.tenda.entrypoints=web,websecure"
      - "traefik.http.routers.tenda.tls=true"
      - "traefik.http.services.tenda.loadbalancer.server.port=5602"
      - "traefik.http.routers.tenda.middlewares=oauth2-proxy-prod"

  # Abada Orun - Frontend for production
  abada-orun:
    build:
      context: ./orun
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-bashizip}/abada-orun:${VERSION:-latest}
    container_name: abada-orun-prod
    environment:
      - NODE_ENV=production
    networks:
      - abada-internal
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.orun.rule=Host(`orun.${APP_HOSTNAME}`)"
      - "traefik.http.routers.orun.entrypoints=web,websecure"
      - "traefik.http.routers.orun.tls=true"
      - "traefik.http.services.orun.loadbalancer.server.port=5603"
      - "traefik.http.routers.orun.middlewares=oauth2-proxy-prod"

volumes:
  postgres_data:
  keycloak_data:
