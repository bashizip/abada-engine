version: '3.8'

services:
  # Abada Engine for testing
  abada-engine:
    build: .
    image: abada-engine:test
    container_name: abada-engine
    environment:
      - SPRING_PROFILES_ACTIVE=test
      - SERVER_PORT=5601
      - DB_PASSWORD=${DB_PASSWORD:-abada123}
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=0.5
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://otel-collector:4318/v1/traces
      - MANAGEMENT_OTLP_METRICS_ENDPOINT=http://otel-collector:4318/v1/metrics
      - OTEL_RESOURCE_ATTRIBUTES_DEPLOYMENT_ENVIRONMENT=test
    # Port removed - access through Traefik
    # Internal port 5601 is only accessible via Traefik
    networks:
      - abada-internal
    restart: "no" # No restart for tests
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5601/api/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      - otel-collector
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.engine-test.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.engine-test.entrypoints=web"
      - "traefik.http.services.engine-test.loadbalancer.server.port=5601"
      - "traefik.http.routers.engine-test.middlewares=oauth2-proxy-test"
      - "traefik.http.middlewares.oauth2-proxy-test.forwardauth.address=http://oauth2-proxy:4180/oauth2/auth"
      - "traefik.http.middlewares.oauth2-proxy-test.forwardauth.authResponseHeaders=X-Auth-Request-User,X-Auth-Request-Groups,X-Auth-Request-Email"

  # Keycloak DB for test (in-memory for faster tests)
  keycloak-db:
    image: postgres:15-alpine
    container_name: keycloak-db-test
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak_test_pw}
    tmpfs:
      - /var/lib/postgresql/data # In-memory for faster tests
    networks:
      - abada-network
    restart: "no"

  # Keycloak for test
  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    container_name: keycloak-test
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN_USERNAME:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak_test_pw}
      - KEYCLOAK_IMPORT=/opt/keycloak/data/import/realm-dev.json
      - KC_PROXY=edge
      - KC_PROXY_HEADERS=xforwarded
    volumes:
      - ./docker/keycloak/import:/opt/keycloak/data/import:ro,z
    command: [ "start-dev", "--import-realm" ]
    ports:
      - "8080:8080"
    networks:
      - abada-network
    restart: "no"
    depends_on:
      - keycloak-db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak-test.rule=Host(`keycloak.localhost`) || PathPrefix(`/auth`)"
      - "traefik.http.routers.keycloak-test.entrypoints=web"
      - "traefik.http.services.keycloak-test.loadbalancer.server.port=8080"

  # Traefik Gateway for test
  traefik:
    image: traefik:v3.0
    container_name: traefik-test
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=abada-internal"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "8081:8080" # Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - abada-network
    restart: "no"

  # OAuth2 Proxy for test
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.5.1
    container_name: oauth2-proxy-test
    command:
      - "--provider=keycloak-oidc"
      - "--client-id=${OAUTH2_PROXY_CLIENT_ID:-abada-frontend}"
      - "--client-secret=${OAUTH2_PROXY_CLIENT_SECRET:-test-secret}"
      - "--cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET:-0000000000000000000000000000000=}"
      - "--oidc-issuer-url=http://keycloak:8080/realms/abada-dev"
      - "--redirect-url=http://localhost/oauth2/callback"
      - "--upstream=http://abada-engine:5601"
      - "--http-address=0.0.0.0:4180"
      - "--email-domain=*"
      - "--cookie-secure=false"
      - "--set-xauthrequest=true"
      - "--pass-authorization-header=true"
      - "--pass-access-token=true"
      - "--skip-jwt-bearer-tokens=true"
      - "--skip-provider-button=true"
      - "--insecure-oidc-allow-unverified-email=true"
    environment:
      - OAUTH2_PROXY_COOKIE_DOMAINS=localhost
    networks:
      - abada-network
    restart: "no"
    depends_on:
      - keycloak

networks:
  abada-public:
    driver: bridge
  abada-internal:
    driver: bridge
    internal: true
