version: '3.8'

services:
  # Abada Engine for development
  abada-engine:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USE_LOCAL_JAR: "true"
    image: abada-engine:dev
    container_name: abada-engine
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=5601
      - DB_PASSWORD=${DB_PASSWORD:-abada123}
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://otel-collector:4318/v1/traces
      - MANAGEMENT_OTLP_METRICS_ENDPOINT=http://otel-collector:4318/v1/metrics
      - OTEL_RESOURCE_ATTRIBUTES_DEPLOYMENT_ENVIRONMENT=dev
      - OTEL_SERVICE_NAME=abada-engine-dev
      - OTEL_RESOURCE_ATTRIBUTES=project=abada,service.version=0.8.3-alpha
    ports:
      - "5601:5601" # Direct access for development
    volumes:
      - ./data:/app/data:z # H2 database persistence (z flag for SELinux)
      - ./logs:/app/logs:z # Application logs for Promtail
    networks:
      - abada-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5601/api/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      otel-collector:
        condition: service_started

  keycloak-db:
    image: postgres:15
    container_name: keycloak-db
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak_dev_pw}
    volumes:
      - ./docker/keycloak/data:/var/lib/postgresql/data:z
    ports:
      - "5433:5432"
    networks:
      - abada-network
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    container_name: keycloak
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN_USERNAME:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak_dev_pw}
      - KEYCLOAK_IMPORT=/opt/keycloak/data/import/realm-export.json
      - KC_PROXY=edge
      - KC_PROXY_HEADERS=xforwarded
    volumes:
      - ./docker/keycloak/import:/opt/keycloak/data/import:ro,z
    command: ["start-dev", "--hostname-strict=false"]
    ports:
      - "8080:8080"
    networks:
      - abada-network
    restart: unless-stopped
    depends_on:
      keycloak-db:
        condition: service_started

  loki:
    image: grafana/loki:2.9.1
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./docker/loki-config-dev.yaml:/etc/loki/local-config.yaml:ro,z
      - ./docker/loki-wal:/tmp/loki/wal
      - ./docker/loki-compactor:/loki/compactor
    ports:
      - "3100:3100"
    networks:
      - abada-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3

  abada-tenda:
    image: abada-tenda:dev
    container_name: abada-tenda
    ports:
      - "5602:5602"
    restart: unless-stopped
    environment:
      - NODE_ENV=dev
    networks:
      - abada-network
    depends_on:
      abada-engine:
        condition: service_started

  abada-orun:
    image: abada-orun:dev
    container_name: abada-orun
    ports:
      - "5603:5603"
    restart: unless-stopped
    environment:
      - NODE_ENV=dev
    networks:
      - abada-network
    depends_on:
      abada-engine:
        condition: service_started

networks:
  abada-network:
    driver: bridge

networks:
  abada-network:
    driver: bridge
