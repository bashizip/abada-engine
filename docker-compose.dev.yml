services:
  # Abada Engine for development
  abada-engine:
    build:
      context: ./engine
      dockerfile: Dockerfile.engine
      args:
        - SKIP_TESTS=true
    image: abada-engine:dev
    container_name: abada-engine
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=5601
      - DB_PASSWORD=${DB_PASSWORD:-abada123}
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://otel-collector:4318/v1/traces
      - MANAGEMENT_OTLP_METRICS_ENDPOINT=http://otel-collector:4318/v1/metrics
      - OTEL_RESOURCE_ATTRIBUTES_DEPLOYMENT_ENVIRONMENT=dev
      - OTEL_SERVICE_NAME=abada-engine-dev
      - OTEL_RESOURCE_ATTRIBUTES=project=abada,service.version=0.8.3-alpha
    ports:
      - "5601:5601"
    # Internal port 5601 is also accessible via Traefik
    volumes:
      - ./data:/app/data:z # H2 database persistence (z flag for SELinux)
      - ./logs:/app/logs:z # Application logs for Promtail
    networks:
      - abada-internal # Engine only on internal network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5601/api/actuator/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      - otel-collector
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.engine-dev.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.engine-dev.entrypoints=web,websecure"
      - "traefik.http.routers.engine-dev.tls=true"
      - "traefik.http.routers.engine-dev.priority=100"
      - "traefik.http.services.engine-dev.loadbalancer.server.port=5601"
      - "traefik.http.routers.engine-dev.service=engine-dev"
      - "traefik.http.routers.engine-dev.middlewares=oauth2-proxy-dev@docker"
      - "traefik.docker.network=abada-internal"

  # PostgreSQL for Keycloak
  keycloak-db:
    image: postgres:15-alpine
    container_name: keycloak-db
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak_dev_pw}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - abada-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Keycloak for Identity Management
  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    container_name: keycloak
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN_USERNAME:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak_dev_pw}
      - KEYCLOAK_IMPORT=/opt/keycloak/data/import/realm-dev.json
      - KC_PROXY=edge
      - KC_HTTP_ENABLED=true
      - KC_HOSTNAME_STRICT=false
      - KC_PROXY_HEADERS=xforwarded
    volumes:
      - ./docker/keycloak/import/realm-dev.json:/opt/keycloak/data/import/realm-dev.json:ro,z
    command: ["start-dev", "--import-realm"]
    ports:
      - "8082:8080" # Direct access for administration if needed
    networks:
      abada-internal:
        aliases:
          - keycloak.localhost
    restart: unless-stopped
    depends_on:
      keycloak-db:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak-dev.rule=Host(`keycloak.localhost`) || PathPrefix(`/auth`)"
      - "traefik.http.routers.keycloak-dev.entrypoints=web,websecure"
      - "traefik.http.services.keycloak-dev.loadbalancer.server.port=8080"
      - "traefik.http.routers.keycloak-dev.service=keycloak-dev"
      - "traefik.http.routers.keycloak-dev.tls=true"
      - "traefik.docker.network=abada-internal"

  # OAuth2 Proxy for JWT validation and header injection
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.5.1
    container_name: oauth2-proxy-dev
    command:
      - "--provider=keycloak-oidc"
      - "--client-id=${OAUTH2_PROXY_CLIENT_ID:-abada-frontend}"
      - "--client-secret=${OAUTH2_PROXY_CLIENT_SECRET:-test-secret}"
      - "--cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET:-0000000000000000000000000000000=}"
      - "--oidc-issuer-url=http://keycloak:8080/realms/abada-dev"
      - "--redirect-url=https://localhost/oauth2/callback"
      - "--upstream=http://abada-engine:5601"
      - "--http-address=0.0.0.0:4180"
      - "--email-domain=*"
      - "--cookie-secure=false"
      - "--set-xauthrequest=true"
      - "--pass-authorization-header=true"
      - "--pass-access-token=true"
      - "--skip-jwt-bearer-tokens=true"
      - "--skip-provider-button=true"
      - "--insecure-oidc-allow-unverified-email=true"
      - "--insecure-oidc-skip-issuer-verification=true"
      - "--user-id-claim=preferred_username"
      - "--ssl-insecure-skip-verify=true"
      - "--whitelist-domain=.localhost"
      - "--cookie-domain=.localhost"
      - "--cookie-samesite=lax"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oauth2-proxy-route.rule=PathPrefix(`/oauth2`)"
      - "traefik.http.routers.oauth2-proxy-route.entrypoints=web,websecure"
      - "traefik.http.routers.oauth2-proxy-route.tls=true"
      - "traefik.http.services.oauth2-proxy-dev.loadbalancer.server.port=4180"
      - "traefik.http.routers.oauth2-proxy-route.service=oauth2-proxy-dev"
      - "traefik.http.middlewares.oauth2-proxy-dev.forwardauth.address=http://oauth2-proxy-dev:4180/oauth2/auth"
      - "traefik.http.middlewares.oauth2-proxy-dev.forwardauth.authResponseHeaders=X-Auth-Request-User,X-Auth-Request-Groups,X-Auth-Request-Email,X-Auth-Request-Access-Token"
      - "traefik.docker.network=abada-internal"
    environment:
      - OAUTH2_PROXY_COOKIE_DOMAINS=.localhost
    networks:
      - abada-internal
    restart: unless-stopped
    depends_on:
      keycloak:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:4180/ping",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Additional components
  abada-tenda:
    image: abada-tenda:latest
    container_name: abada-tenda
    build:
      context: ./tenda
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
      - VITE_API_URL=/api
      - VITE_KEYCLOAK_URL=https://keycloak.localhost
      - VITE_KEYCLOAK_REALM=abada-dev
      - VITE_KEYCLOAK_CLIENT_ID=abada-frontend
    ports:
      - "5602:5602"
    networks:
      - abada-internal
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tenda-dev.rule=Host(`tenda.localhost`)"
      - "traefik.http.routers.tenda-dev.entrypoints=web,websecure"
      - "traefik.http.routers.tenda-dev.tls=true"
      - "traefik.http.routers.tenda-dev.priority=10"
      - "traefik.http.services.tenda-dev.loadbalancer.server.port=5602"
      - "traefik.http.routers.tenda-dev.service=tenda-dev"
      - "traefik.docker.network=abada-internal"

  abada-orun:
    image: abada-orun:latest
    container_name: abada-orun
    build:
      context: ./orun
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
    ports:
      - "5603:5603"
    networks:
      - abada-internal
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.orun-dev.rule=Host(`orun.localhost`)"
      - "traefik.http.routers.orun-dev.entrypoints=web,websecure"
      - "traefik.http.routers.orun-dev.tls=true"
      - "traefik.http.services.orun-dev.loadbalancer.server.port=5603"
      - "traefik.http.routers.orun-dev.service=orun-dev"
      - "traefik.http.routers.orun-dev.middlewares=oauth2-proxy-dev@docker"
      - "traefik.docker.network=abada-internal"

volumes:
  keycloak_db_data:
